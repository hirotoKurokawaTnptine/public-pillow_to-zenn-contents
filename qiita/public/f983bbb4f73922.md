---
title: ã€Powershellã€‘ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’è‡ªä½œã—ã¦ã¿ãŸ
published_at: '2025-08-22 02:08'
private: false
tags:
  - powershell
  - windows
  - é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°
  - closure
updated_at: '2025-08-23T21:40:03.726Z'
id: null
organization_url_name: null
slide: false
---

## ã‚³ãƒ¼ãƒ‰ã ã‘è¦‹ãŸã„äººç”¨
è¦‹ãŸã‘ã‚Šã‚ƒå…ˆã«è¦‹ã›ã¦ã‚„ã‚‹ã‚ˆâ€¦
<details><summary>è‡ªä½œã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£</summary>

ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯å†…ã®å¤‰æ•°ã®ã¿å†…å´ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã«ä¼æ¬ã—ã¾ã™ã€‚
functionå®šç¾©ã®èª­ã¿è¾¼ã¿ã«ã¤ã„ã¦ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
ãã¡ã‚‰ã®æ”¹ä¿®ã¯å„è‡ªã«ä»»ã›ãŸã„ï¼ˆæ€ æ…¢ï¼‰


```Powershell:Closure.ps1
using namespace System.Management.Automation.Language
class Closure{
    hidden [ValidateNotNull()][scriptblock]$function
    hidden [ValidateNotNull()][hashtable]$capturedScope = @{}

    Closure(){}
    Closure([scriptblock]$func, [hashtable]$capturedScope = @{}){
        $this.function = $func
        $this.capturedScope = $capturedScope
    }
    Closure([scriptblock]$func){
        $this.function = $func
        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯å®šç¾©æ™‚ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        $this.capturedScope = @{}
        $varNames = [Closure]::getVarNamesInFuncScope($func)
        foreach($varName in $varNames){
            $exitVar =  Get-Variable -Name $varName -ValueOnly -Scope Script `
                -ErrorAction SilentlyContinue
            if($null -ne $exitVar){ $this.capturedScope[$varName] = $exitVar; continue }
            $exitVar = Get-Variable -Name $varName -ValueOnly -Scope Global `
                -ErrorAction SilentlyContinue
            if($null -ne $exitVar){ $this.capturedScope[$varName] = $exitVar }
        }
    }

    [object]Invoke([object[]]$arg){
        #ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸå¤‰æ•°ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¹ã‚³ãƒ¼ãƒ—ã«å±•é–‹
        foreach($key in $this.capturedScope.Keys){
            Set-Variable -Name $key -Value $this.capturedScope[$key] -Scope Local
        }
        #ãƒ‰ãƒƒãƒˆã‚½ãƒ¼ã‚¹ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ã‚’ãƒ¡ã‚½ãƒƒãƒ‰å†…ã¨åŒä¸€ã«ã™ã‚‹ãŸã‚ï¼‰
        $result = . $this.function @arg

        #æˆ»ã‚Šå€¤ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯/ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã§ãªã‘ã‚Œã°
        #ç¾åœ¨ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ç›´ã—ã¦ã‹ã‚‰çµæœã‚’è¿”ã™
        if($result -isnot [scriptblock] -and $result -isnot [Closure]){
            $varNames = [Closure]::getVarNamesInFuncScope($this.function)
            foreach($varName in $varNames){
                $this.capturedScope[$varName] = Get-Variable -Name $varName -ValueOnly `
                    -Scope Local -ErrorAction SilentlyContinue
            }
            return $result
        }

        #æˆ»ã‚Šå€¤ãŒã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®å ´åˆ
        if($result -is [Closure]){
            #å†…å´ã®ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãŒã‚­ãƒ£ãƒ—ãƒãƒ£æ¸ˆã®å¤‰æ•°ã‚’å–å¾—
            $caputerdScopeInInner = $result.capturedScope.Clone() #ã‚·ãƒ£ãƒ­ãƒ¼ã‚³ãƒ”ãƒ¼ãªã®ã§æ³¨æ„
            
            #ç¾åœ¨å±•é–‹æ¸ˆã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰å†…å´ã®ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã«å¿…è¦ãªå¤‰æ•°ã‚’æŠ½å‡º
            #é‡è¤‡ã—ãŸå¤‰æ•°ã¯ä¸Šæ›¸ãã™ã‚‹ï¼ˆå„ªå…ˆåº¦ï¼šãƒ¡ã‚½ãƒƒãƒ‰å†…ã‚¹ã‚³ãƒ¼ãƒ— ï¼ å†…å´ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
            $varNames = [Closure]::getVarNamesInFuncScope($result.function)
            foreach($varName in $varNames){
                $varExit = Get-Variable -Name $varName -ValueOnly -Scope Local `
                    -ErrorAction SilentlyContinue
                if($null -ne $varExit){ $caputerdScopeInInner[$varName]=$varExit;continue }
                #ã©ã®ã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚‚å­˜åœ¨ã—ãªã„å¤‰æ•°ã«ã¯nullã‚’å‰²ã‚Šå½“ã¦ã‚‹
                if(-not $caputerdScopeInInner.ContainsKey($varName)){
                    $caputerdScopeInInner[$varName] = $null
                }
            }

            #æ–°ã—ã„ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’è¿”ã™
            return [Closure]@{
                function = $result.function
                capturedScope = $caputerdScopeInInner
            }
        }

        #æˆ»ã‚Šå€¤ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®å ´åˆ
        #ç¾åœ¨å±•é–‹æ¸ˆã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã«å¿…è¦ãªå¤‰æ•°ã‚’æŠ½å‡º
        $varScopeToCapture = @{}
        $varNames = [Closure]::getVarNamesInFuncScope($result)
        foreach($varName in $varNames){
            $varScopeToCapture[$varName] = Get-Variable -Name $varName -ValueOnly `
                -Scope Local -ErrorAction SilentlyContinue
        }

        #æ–°ã—ã„Closureã‚’ä½œæˆ
        return [Closure]@{
            function = $result
            capturedScope = $varScopeToCapture
        }
    }

    #ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¹ã‚³ãƒ¼ãƒ—å†…ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹å¤‰æ•°ã®åå‰ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
    hidden static [string[]]getVarNamesInFuncScope([scriptblock]$func){
        $ast = [Parser]::ParseInput($func.ToString(), [ref]$null, [ref]$null)
        $varNames = $ast.FindAll({$args[0] -is [VariableExpressionAst]}, $true) | 
            ForEach-Object { $_.VariablePath.UserPath } | Select-Object -Unique
        return $varNames
    }
}
```

```Powershell:ä½¿ã„æ–¹
$add_curry = {
    param($x) return {
        param($y) return {
            param($z) return $x + $y + $z
        }
    }
}

[Closure]::new($add_curry).Invoke(1).Invoke(2).Invoke(3) #6
```
</details>


## ã¯ã˜ã‚ã«
åˆæŠ•ç¨¿ã§ã™ã€‚
Powershellã‚’å‹‰å¼·ã—å§‹ã‚ã¦ç´„2å¹´ã€‚
ç§ã¯`GetNewClosure`ã¨ã®æˆ¦ã„ã«ã‚ˆã£ã¦å¤§ããªå‚·ã‚’è² ã„ã€ä½™å‘½å¹¾ã°ãã‚‚ç„¡ã„çŠ¶æ…‹ã«ã‚ã‚Šã¾ã™ã€‚

çš†ã•ã‚“ã«ã¯è‡ªåˆ†ã¨åŒã˜è½ã‚’è¸ã‚“ã§ã»ã—ããªã„â”€â”€ãã®ä¸€å¿ƒã§æœ€æœŸã®åŠ›ã‚’æŒ¯ã‚Šçµã‚Šã€ã“ã®è¨˜äº‹ã‚’æ®‹ã—ã¾ã™â€¦ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€ä»¥ä¸‹ã‚’æ‰±ã„ã¾ã™ğŸ‘‡

- `GetNewClosure` ã®åŸºæœ¬çš„ãªå‹•ä½œ
- ãã®åˆ¶é™ã‚’å›é¿ã™ã‚‹å¿œæ€¥å‡¦ç½®çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
- ãã—ã¦ã‚ˆã‚Šç›´æ„Ÿçš„ã«æ‰±ãˆã‚‹ã€Œè‡ªä½œã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã€ã®ç´¹ä»‹

æ‹™ã„æ–‡ç« ã§ã¯ã‚ã‚Šã¾ã™ãŒã€èª°ã‹ã®å­¦ç¿’ã‚„é–‹ç™ºã®åŠ©ã‘ã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚


## å¯¾è±¡èª­è€…
- Powershellã‚’ã‚ã‚‹ç¨‹åº¦ä½¿ç”¨ã§ãã‚‹æ–¹
- ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ï¼ˆé–¢æ•°ï¼‰ã¨ã‚¯ãƒ©ã‚¹ã‚’æ‰±ãˆã‚‹æ–¹
> ~~`GetNewClosure` ã§ã”å®¶æ—ã‚’äº¡ãã•ã‚ŒãŸæ–¹~~ 


## ğŸ˜¡ãã‚‚ãã‚‚ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã£ã¦ãªã«ï¼Ÿ
ã–ã£ãã‚Šã„ã†ã¨ã€Œé–¢æ•°ãŒä½œã‚‰ã‚ŒãŸã¨ãã®å¤–å´ã®å¤‰æ•°ã‚’è¦šãˆã¦ãŠã„ã¦ã€ã‚ã¨ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ã‚‚ãã®å¤‰æ•°ã‚’å‚ç…§ã§ãã‚‹ä»•çµ„ã¿ã€ã§ã™ã€‚
å†…éƒ¨çš„ãªæ‰€ã¯ã€ã¯ã¦ãªãƒ–ãƒ­ã‚°ã•ã‚“ãŒç«¯çš„ã«èª¬æ˜ã—ã¦ãã‚Œã¦ã¾ã—ãŸã€‚

> é–¢æ•°å†…ã«å‡ºç¾ã™ã‚‹è‡ªç”±å¤‰æ•°ï¼ˆé–¢æ•°å†…ã§å®£è¨€ã•ã‚Œã¦ã„ãªã„å¤‰æ•°ï¼‰ã®è§£æ±ºã®éš›ã€å®Ÿè¡Œæ™‚ã®ç’°å¢ƒã§ã¯ãªãã€é–¢æ•°ã‚’å®šç¾©ã—ãŸç’°å¢ƒã®å¤‰æ•°ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã€‚([ã¯ã¦ãªãƒ–ãƒ­ã‚°](https://d.hatena.ne.jp/keyword/%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3)ã‚ˆã‚Š)

ã¯ãˆï¼¾ã€œã™ã£ã”ãå˜ç´”ãƒ»ãƒ»ãƒ»

#### é›°å›²æ°—ã‚µãƒ³ãƒ—ãƒ«ğŸ‘‡ï¼ˆJavaScriptï¼‰
  ```JavaScript
function MakeCounter() {
    var count = 0
    return () => ++count
}

let counter = MakeCounter()
console.log(counter()) # 1
console.log(counter()) # 2
console.log(counter()) # 3
```

ã¤ã¾ã‚Šä¾¿åˆ©ã£ã¦ã“ã¨ğŸ‘ŠğŸ˜

## ğŸ‘¿æ‚ªé­”ã€ŒGetNewClosureã€ã®æŒ™å‹•
ã¾ãšã¯ã€MakeCounterã‚’Powershellã§å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚
```Powershell
function MakeCounter() {
    $count = 0

    #ã€Œ$script:ã€ã‚’ä½¿ç”¨ã—ãªã„ã¨å¤‰æ›´ä¸å¯ï¼ˆå‚ç…§ã¯å¯èƒ½ï¼‰
    return { (++$script:count) }.GetNewClosure()
}
$counter = MakeCounter
& $counter # 1
& $counter # 2
& $counter # 3
```
ã¾ã ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã¨ã—ã¦ã¡ã‚ƒã‚“ã¨æ©Ÿèƒ½ã—ã¦ã„ã¾ã™ã€‚
ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªä¾‹ã§ã“ã®å‹•ãã¯ç ´ç¶»ã—ã¾ã™ã€‚

#### ã•ã‚‰ã«ä¸€æ®µãƒã‚¹ãƒˆ
ã€Œå¤–å´ã®æ–‡è„ˆã‚’ã ã‚“ã ã‚“å—ã‘æ¸¡ã™ã€ç³»ï¼ˆã‚«ãƒªãƒ¼åŒ–/éƒ¨åˆ†é©ç”¨ï¼‰ã§ç ´ç¶»ãŒæ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚
```Powershell
# 3æ®µã‚«ãƒªãƒ¼åŒ–ã®ã¤ã‚‚ã‚Š
$addC = {
    param($x) return {
        param($y) return {
            param($z) return $x + $y + $z
        }.GetNewClosure()
    }.GetNewClosure()
}                                    

# ã“ã“ã¾ã§ã¯è‰¯ã•ãã†ã«è¦‹ãˆã‚‹ãŒâ€¦
$addy = & $addC 1     # å†…å´ã® { param($y) ... } ãŒè¿”ã‚‹
$addz = & $addy 2     # æœ€æ·±éƒ¨ã® { param($z) ... } ãŒè¿”ã‚‹
# ã“ã“ã§è¬ã®å€¤ãŒè¿”ã‚‹
& $addz 3             # æœŸå¾…: 6 / å®Ÿéš›: 5
```
ãŠã„ğŸ˜¡

#### ãªãœã“ã†ãªã‚‹ï¼Ÿ
çµè«–ã‹ã‚‰è¨€ã†ã¨ã€`$x`ãŒå†…å´ã®é–¢æ•°ã‹ã‚‰å‚ç…§ã§ãã¦ã„ã¾ã›ã‚“ã€‚
`GetNewClosure`ã¯å‘¼ã³å‡ºã•ã‚ŒãŸæ™‚ã®éšå±¤ã®ã€Œé€šå¸¸ã‚¹ã‚³ãƒ¼ãƒ—ã€ã‚’ã€Œç‹¬è‡ªã‚¹ã‚³ãƒ¼ãƒ—ã€ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚
ã‚­ãƒ£ãƒ—ãƒãƒ£ç¯„å›²ã¯é€šå¸¸ã‚¹ã‚³ãƒ¼ãƒ—ã ã‘ã ã‘ã©ã€ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸçŠ¶æ…‹ã¯ç‹¬è‡ªã‚¹ã‚³ãƒ¼ãƒ—ã«æŸç¸›ã•ã‚Œã‚‹ã®ã§ã€å‰å›æŸç¸›ã—ãŸçŠ¶æ…‹ã¯å†…å´ã®`GetNewClosure`ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ç¯„å›²å¤–ã«ãªã‚Šã¾ã™ã€‚
ãã®çµæœã€`$x`ã¯æŸç¸›ç¯„å›²å¤–ã«ãªã£ã¦å‚ç…§ã‹ã‚‰æ¼ã‚Œã¾ã™ã€‚ã¯ãï½ã¤ã£ã‹ãˆ

## ğŸ¤•å¿œæ€¥æªç½®
ã€Œã¨ã‚Šã‚ãˆãšå‹•ã‹ã—ãŸã„ã€æ™‚ã®ç¾å®Ÿè§£ï¼ˆå¤šåˆ†ï¼‰

### â‘ åŒã˜éšå±¤ã§å¤‰æ•°ã‚’å†å®£è¨€ã™ã‚‹ï¼ˆãŠã™ã™ã‚ï¼‰
ãŸã¶ã‚“ã“ã‚ŒãŒä¸€ç•ªæ—©ã„ã¨æ€ã„ã¾ã™ã€‚
```Powershell
$addC = {
    param($x) return {
        param($y)
        $local:x = $x    # â† ã“ã“å…¥ã‚ŒãŸã‚‰å‹•ã
        return {
            param($z) return $x + $y + $z
        }.GetNewClosure()
    }.GetNewClosure()
}                                    
```
- âœ…ã‚³ãƒ¼ãƒ‰ã¸ã®å¤‰æ›´ãŒå°‘ãªã„
- âŒäº‹æƒ…ã‚’çŸ¥ã‚‰ãªã„äººã‹ã‚‰ã¿ã‚‹ã¨è¬ã®å†å®£è¨€
---
### â‘¡ã¡ã‚ƒã‚“ã¨å¼•æ•°ã§æ¸¡ã™ï¼ˆç‹é“ï¼‰
æ¨ªç€ã—ã¦ã¯ã„ã‘ãªã„ï¼ˆæˆ’ã‚ï¼‰
```Powershell
$addC = {
    param($x,$y,$z)
    return $x + $y + $z
}                                
```
- âœ… æ˜ç¤ºçš„ã§å®‰å…¨ã€èª­ã¿ã‚„ã™ã„
- âŒ å‚ç…§ã—ãŸã„å¤‰æ•°ãŒå¢—ãˆã‚‹ã»ã©å¼•æ•°ãŒå¢—æ®–ã—ã¦ã—ã‚“ã©ã„

---
### â‘¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ/ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®šï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰
:::note alert
ãŠã™ã™ã‚ã§ãã‚‹è¦ç´ ã¯ã»ã¼ãªã„ã§ã™ã€‚
æœ¬å½“ã«æœ¬å½“ã®æœ€çµ‚æ‰‹æ®µï¼
:::
```Powershell
$addC = {
    param($x)
    $script:x = $x
    return {
        param($y)
        $script:y = $y
        return {
            param($z) return $x + $y + $z
        }
    }
}                             
```
- âœ… ç°¡å˜
- âŒ ç’°å¢ƒæ±šæŸ“

## ğŸ› ï¸è‡ªä½œã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã¸ã®æŒ‘æˆ¦
ã“ã“ã¾ã§ã§åˆ†ã‹ã£ãŸã®ã¯ã€
- `GetNewClosure`å˜ä½“ã§ã¯ã€Œä¸Šã®éšå±¤ã®å¤‰æ•°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã§ããªã„ã€
- å¿œæ€¥å‡¦ç½®ã¯ã‚ã‚‹ã‘ã©ã€ã©ã‚Œã‚‚ã‚¤ãƒã‚¤ãƒæ ¼å¥½ãŒã¤ã‹ãªã„

ã¨ã„ã†ã“ã¨ã€‚

> ã€Œã˜ã‚ƒã‚ã€è‡ªåˆ†ã§â€å¤‰æ•°ã‚­ãƒ£ãƒ—ãƒãƒ£æ©Ÿèƒ½â€ã‚’ä½œã£ã¡ã‚ƒãˆï¼ã€

â€¦ãã†è€ƒãˆã¦å®Ÿè£…ã—ãŸã®ãŒã€ä»Šå›ã®`Closure`ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

## ğŸ©è‡ªä½œã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®ã‚¢ã‚¤ãƒ‡ã‚¢
ã‚·ãƒ³ãƒ—ãƒ«ã«è¨€ã†ã¨ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ï¼“ã¤
1. ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯å†…ã§å‚ç…§ã—ã¦ã„ã‚‹å¤‰æ•°åã‚’ASTã§è§£æ
2. ãã®å¤‰æ•°ã‚’Script/Globalã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰å›åã—ã¦ãƒãƒƒã‚·ãƒ¥ã«ä¿æŒï¼ˆï¼ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼‰
3. å®Ÿè¡Œæ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¨ã—ã¦å¾©å…ƒã—ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™

ã“ã‚Œã§é–¢æ•°å®šç¾©ã®ç’°å¢ƒã‚’å†ç¾ã§ãã¾ã™ã€‚
ã•ã‚‰ã«`Invoke()`å†…ã§å·¥å¤«ã—ã¦ã„ã‚‹ã®ã§ã€ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãŒã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’è¿”ã™å ´åˆã§ã‚‚ã‚¹ã‚³ãƒ¼ãƒ—ãŒä¼æ¬ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã‚«ãƒªãƒ¼åŒ–ãƒ»éƒ¨åˆ†é©ç”¨ã«ã‚‚å¿œç”¨ã§ãã¾ã™ã€‚


## ğŸ“‘ã‚³ãƒ¼ãƒ‰å…¨æ–‡ï¼ˆå†åº¦ï¼‰
<details><summary>è‡ªä½œã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£</summary>

```Powershell:Closure.ps1
using namespace System.Management.Automation.Language
class Closure{
    hidden [ValidateNotNull()][scriptblock]$function
    hidden [ValidateNotNull()][hashtable]$capturedScope = @{}

    Closure(){}
    Closure([scriptblock]$func, [hashtable]$capturedScope = @{}){
        $this.function = $func
        $this.capturedScope = $capturedScope
    }
    Closure([scriptblock]$func){
        $this.function = $func
        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯å®šç¾©æ™‚ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        $this.capturedScope = @{}
        $varNames = [Closure]::getVarNamesInFuncScope($func)
        foreach($varName in $varNames){
            $exitVar =  Get-Variable -Name $varName -ValueOnly -Scope Script `
                -ErrorAction SilentlyContinue
            if($null -ne $exitVar){ $this.capturedScope[$varName] = $exitVar; continue }
            $exitVar = Get-Variable -Name $varName -ValueOnly -Scope Global `
                -ErrorAction SilentlyContinue
            if($null -ne $exitVar){ $this.capturedScope[$varName] = $exitVar }
        }
    }

    [object]Invoke([object[]]$arg){
        #ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸå¤‰æ•°ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¹ã‚³ãƒ¼ãƒ—ã«å±•é–‹
        foreach($key in $this.capturedScope.Keys){
            Set-Variable -Name $key -Value $this.capturedScope[$key] -Scope Local
        }
        #ãƒ‰ãƒƒãƒˆã‚½ãƒ¼ã‚¹ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ã‚’ãƒ¡ã‚½ãƒƒãƒ‰å†…ã¨åŒä¸€ã«ã™ã‚‹ãŸã‚ï¼‰
        $result = . $this.function @arg

        #æˆ»ã‚Šå€¤ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯/ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã§ãªã‘ã‚Œã°
        #ç¾åœ¨ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ç›´ã—ã¦ã‹ã‚‰çµæœã‚’è¿”ã™
        if($result -isnot [scriptblock] -and $result -isnot [Closure]){
            $varNames = [Closure]::getVarNamesInFuncScope($this.function)
            foreach($varName in $varNames){
                $this.capturedScope[$varName] = Get-Variable -Name $varName -ValueOnly `
                    -Scope Local -ErrorAction SilentlyContinue
            }
            return $result
        }

        #æˆ»ã‚Šå€¤ãŒã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®å ´åˆ
        if($result -is [Closure]){
            #å†…å´ã®ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãŒã‚­ãƒ£ãƒ—ãƒãƒ£æ¸ˆã®å¤‰æ•°ã‚’å–å¾—
            $caputerdScopeInInner = $result.capturedScope.Clone() #ã‚·ãƒ£ãƒ­ãƒ¼ã‚³ãƒ”ãƒ¼ãªã®ã§æ³¨æ„
            
            #ç¾åœ¨å±•é–‹æ¸ˆã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰å†…å´ã®ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã«å¿…è¦ãªå¤‰æ•°ã‚’æŠ½å‡º
            #é‡è¤‡ã—ãŸå¤‰æ•°ã¯ä¸Šæ›¸ãã™ã‚‹ï¼ˆå„ªå…ˆåº¦ï¼šãƒ¡ã‚½ãƒƒãƒ‰å†…ã‚¹ã‚³ãƒ¼ãƒ— ï¼ å†…å´ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
            $varNames = [Closure]::getVarNamesInFuncScope($result.function)
            foreach($varName in $varNames){
                $varExit = Get-Variable -Name $varName -ValueOnly -Scope Local `
                    -ErrorAction SilentlyContinue
                if($null -ne $varExit){ $caputerdScopeInInner[$varName]=$varExit;continue }
                #ã©ã®ã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚‚å­˜åœ¨ã—ãªã„å¤‰æ•°ã«ã¯nullã‚’å‰²ã‚Šå½“ã¦ã‚‹
                if(-not $caputerdScopeInInner.ContainsKey($varName)){
                    $caputerdScopeInInner[$varName] = $null
                }
            }

            #æ–°ã—ã„ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’è¿”ã™
            return [Closure]@{
                function = $result.function
                capturedScope = $caputerdScopeInInner
            }
        }

        #æˆ»ã‚Šå€¤ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®å ´åˆ
        #ç¾åœ¨å±•é–‹æ¸ˆã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã«å¿…è¦ãªå¤‰æ•°ã‚’æŠ½å‡º
        $varScopeToCapture = @{}
        $varNames = [Closure]::getVarNamesInFuncScope($result)
        foreach($varName in $varNames){
            $varScopeToCapture[$varName] = Get-Variable -Name $varName -ValueOnly `
                -Scope Local -ErrorAction SilentlyContinue
        }

        #æ–°ã—ã„Closureã‚’ä½œæˆ
        return [Closure]@{
            function = $result
            capturedScope = $varScopeToCapture
        }
    }

    #ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¹ã‚³ãƒ¼ãƒ—å†…ã§å‚ç…§ã•ã‚Œã¦ã„ã‚‹å¤‰æ•°ã®åå‰ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
    hidden static [string[]]getVarNamesInFuncScope([scriptblock]$func){
        $ast = [Parser]::ParseInput($func.ToString(), [ref]$null, [ref]$null)
        $varNames = $ast.FindAll({$args[0] -is [VariableExpressionAst]}, $true) | 
            ForEach-Object { $_.VariablePath.UserPath } | Select-Object -Unique
        return $varNames
    }
}
```
</details>

## ğŸ”åˆ†å‰²ã—ã¦è§£èª¬

### Invokeãƒ¡ã‚½ãƒƒãƒ‰ã®å½¹å‰²
1. ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸå¤‰æ•°ã‚’å±•é–‹ã™ã‚‹
`Invoke()`ã¯ã¾ãšã€`capturedScope`ã«ä¿å­˜ã—ã¦ãŠã„ãŸå¤‰æ•°ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å±•é–‹ã—ã¾ã™ã€‚
ã“ã“ãŒ"å¤–å´ã®æ–‡è„ˆã‚’å‘¼ã³æˆ»ã™"è‚ã§ã™ã€‚
```Powershell
foreach($key in $this.capturedScope.Keys){
    Set-Variable -Name $key -Value $this.capturedScope[$key] -Scope Local
}
```
   - `-Scope Local`ã‚’æ˜ç¤ºã™ã‚‹ã“ã¨ã§ã€ã„ã¾å®Ÿè¡Œã—ã¦ã„ã‚‹`Invoke()`ã®ã‚¹ã‚³ãƒ¼ãƒ—ã«å€¤ã‚’å±•é–‹ã—ã¾ã™ã€‚
   - ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯æœ¬ä½“ã‹ã‚‰å¤–å´ã§å®šç¾©ã—ãŸçŠ¶æ…‹ã‚’å‚ç…§ã§ãã¾ã™ã€‚


2. æœ¬ä½“ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹
```Powershell
$result = . $this.function @arg
```
   - ãƒ‰ãƒƒãƒˆã‚½ãƒ¼ã‚¹ã§å‘¼ã³å‡ºã™ã“ã¨ã§`Invoke()`å†…ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¨`$this.function`å†…éƒ¨ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æƒãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
   - å¼•æ•°ã¯`Object[]`å‹ã§å—ã‘å–ã‚‹ã“ã¨ã§ã€å¼•æ•°ã®æ•°ã«å¯¾ã—ã¦æŸ”è»Ÿã«å¯¾å¿œã§ãã¾ã™ã€‚


3. æˆ»ã‚Šå€¤ãŒæ™®é€šã®å€¤ã®å ´åˆ
   - å˜ãªã‚‹å€¤ï¼ˆæ•°å€¤ã‚„æ–‡å­—åˆ—ãªã©ï¼‰ã®å ´åˆã¯ã€ãã®ã¾ã¾è¿”ã—ã¾ã™ã€‚
   - ãŸã ã—`$this.function`å†…ã§æ›´æ–°ã•ã‚ŒãŸå¤‰æ•°ã‚’æ¬¡å›ã®å®Ÿè¡Œæ™‚ã«æŒã¡è¶Šã™ãŸã‚ã€
  å€¤ã‚’è¿”ã™å‰ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ç›´ã—ã¾ã™ã€‚

  
4. æˆ»ã‚Šå€¤ãŒScriptBlockã®å ´åˆ
   - æ–°ã—ãè¿”ã£ã¦ããŸ ScriptBlock ãŒå‚ç…§ã™ã‚‹å¤‰æ•°ã‚’å†åé›†
   - ãã‚Œã‚’åŸºã«æ–°ã—ã„`Closure`ã«åŒ…ã¿è¾¼ã‚“ã§è¿”ã—ã¾ã™ã€‚

   
5. æˆ»ã‚Šå€¤ãŒClosureã®å ´åˆ
   - æ—¢å­˜ã®`Closure`ãŒæŒã£ã¦ã„ã‚‹
   capturedScopeã¨ç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ãƒãƒ¼ã‚¸
   - é‡è¤‡ã¯ã€Œã„ã¾ã®ãƒ­ãƒ¼ã‚«ãƒ«ã€ã‚’å„ªå…ˆã—ã¦æ–°ã—ã„`Closure`ã‚’è¿”ã™


### ScriptBlockã‚’è¿”ã—ãŸã¨ã
ã€Œ`ScriptBlock`ã‚’è¿”ã™=æ¬¡ã®éšå±¤ã®é–¢æ•°ã‚’è¿”ã™ã€ãªã®ã§ã€ç¾åœ¨éšå±¤æœªæº€ã§å¿…è¦ã¨ã™ã‚‹å¤‰æ•°ã‚’ä¼æ¬ã—ã¾ã™ã€‚
1. è¿”ã£ã¦ããŸ`ScriptBlock`ã‚’ASTè§£æ
2. `VariableExpressionAst`ã‹ã‚‰å‚ç…§ã™ã‚‹å¤‰æ•°åã ã‘ã‚’æŠ½å‡º
3. **"ã„ã¾ã®ãƒ­ãƒ¼ã‚«ãƒ«"**ã‹ã‚‰è©²å½“åã®å€¤ã‚’å†åé›†ã—ã€ç¾åœ¨ã®è¾æ›¸ã®å€¤ã‚’ä¸Šæ›¸ãã™ã‚‹
4. ãã®è¾æ›¸ã‚’`capturedScope`ã«ã—ãŸæ–°ã—ã„`Closure`ã‚’è¿”ã™

ã“ã‚Œã§ã€Œå¿…è¦ãªåˆ†ã®å¤–éƒ¨æ–‡è„ˆã€ã‚’ä¼æ¬ã§ãã¾ã™ã€‚
ã¨ãã«ã‚«ãƒªãƒ¼åŒ–ã®ã‚ˆã†ã«æ®µã‚’è·¨ã„ã§æ–‡è„ˆã‚’å—ã‘æ¸¡ã™å¿…è¦ã®ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã§åŠ¹ã„ã¦ãã¾ã™ã€‚


### Closureã‚’è¿”ã—ãŸã¨ã
ã€Œ`Closure`ã‚’è¿”ã™=ã™ã§ã«"çŠ¶æ…‹ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£æ¸ˆã¿"ã®ScriptBlockã‚’è¿”ã™ã€
ã“ã“ã§è¡Œã†å¿…è¦ã®ã‚ã‚‹ã‚‚ã®ã¯æ—¢å­˜ã®è¾æ›¸ã¨ã®**ãƒãƒ¼ã‚¸**ã§ã™ã€‚
- å†…å´ã®`captureedScope`:ã™ã§ã«ç¢ºä¿æ¸ˆã¿ã®æ–‡è„ˆ
- ç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«:ç›´å‰ã®å®Ÿè¡Œã§æ–°ãŸã«ç¢ºå®šã—ãŸæœ€æ–°ã®æ–‡è„ˆ
> æ–¹é‡ï¼šä»Šã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ãŒæ­£
> å¤‰æ•°åè¡çªæ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚’å„ªå…ˆã—ã¦ä¸Šæ›¸ãã—ã¾ã™ã€‚
> ã“ã‚Œã¯ã€Œç›´å‰ã®æ®µã§æ±ºã¾ã£ãŸå€¤ã‚’å„ªå…ˆã™ã‚‹ã€ç›´æ„Ÿã«åˆè‡´ã—ã¾ã™ã€‚

çµæœã¨ã—ã¦ã€**å…¥ã‚Œå­ã®é€£é–**ã§ã‚‚**ç ´ç¶»ã›ãšã«æ–‡è„ˆãŒä¼æ¬**ã—ã¦ã„ãã¾ã™ã€‚


## âš ï¸æ³¨æ„ãƒ»é™ç•Œ
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼šASTè§£æï¼‹å±•é–‹ã®åˆ†ã€ãƒã‚¤ãƒ†ã‚£ãƒ–`GetNewClosure`ã‚ˆã‚Šå‹•ä½œãŒé‡ããªã‚‹å¯èƒ½æ€§ã€‚ãƒ›ãƒƒãƒˆãƒ‘ã‚¹ã¯è¨ˆæ¸¬æ¨å¥¨
- é–¢æ•°å®šç¾©ã®å®Œå…¨ã‚µãƒãƒ¼ãƒˆï¼šä»Šå›ã¯ã€Œå¤‰æ•°ã€ã®ä¼æ¬ãŒä¸»çœ¼ã€‚function å®šç¾©ã®æ‰±ã„ã¯ç”¨é€”ã«å¿œã˜ã¦è¦æ¤œè¨¼


## ã¾ã¨ã‚
- `GetNewClosure`ã¯ãƒã‚¹ãƒˆã§ç ´ç¶»ã—ã‚„ã™ã„
- è‡ªä½œClosureã¯ ASTã§å‚ç…§å¤‰æ•°ã‚’æŠ½å‡º â†’ Script/Globalã‹ã‚‰ã‚­ãƒ£ãƒ—ãƒãƒ£ â†’ å®Ÿè¡Œæ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ã¸å¾©å…ƒ
- ã•ã‚‰ã« æˆ»ã‚Šå€¤ã«å¿œã˜ãŸå†ã‚­ãƒ£ãƒ—ãƒãƒ£/ãƒãƒ¼ã‚¸ ã§ã€æ¬¡ã®æ®µã«ã‚‚æ–‡è„ˆãŒä¼æ¬
- çµæœã¨ã—ã¦ã€ã‚«ãƒªãƒ¼åŒ–ã‚„éƒ¨åˆ†é©ç”¨ã‚’ç›´æ„Ÿçš„ã«æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚‹

---
å¾ŒåŠéƒ¨åˆ†ã§ã ã„ã¶åŠ›å°½ãã¦ã¾ã™ã€‚ã‚„ã£ã±ã‚ŠçœŸé¢ç›®ã«æ–‡ç« ã‚’ã¾ã¨ã‚ã‚‹ã®ã¯é›£ã—ã„ã§ã™ã­â€¦